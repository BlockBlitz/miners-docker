name: Build Rqiner-ZLUDA

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

env:
  REGISTRY: ghcr.io
  ORG_NAME: blockblitz
  IMAGE_NAME: rqiner-zluda
  DOCKER_CONTEXT: ./rqiner-zluda/.

jobs:
  check_ver:
    name: Check Release is Built
    runs-on: ubuntu-latest
    steps:
    - id: lastrelease 
      name: Get Latest Release
      uses: pozetroninc/github-action-get-latest-release@v0.7.0
      with:
        repository: Qubic-Solutions/rqiner-gpu-builds
        token: ${{ secrets.GITHUB_TOKEN }}
    - id: releaseexists
      name: Check Package Builds
      uses: tyriis/docker-image-tag-exists@49cd47e11a5fb368696d68284ca7fecce53fcc43
      with:
        registry: ${{ env.REGISTRY }}
        repository: ${{ env.ORG_NAME }}/${{ env.IMAGE_NAME }}
        tag: ${{ steps.lastrelease.outputs.release }}
        token: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      image-exists: ${{ steps.releaseexists.outputs.tag }}
      release-ver: ${{ steps.lastrelease.outputs.release }}
  build:
    name: Build Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    needs:
      - check_ver
    if: needs.check_ver.outputs.image_exists == 'not found'
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Docker Login
      uses: docker/login-action@v3.1.0
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and push Docker images
      uses: docker/build-push-action@v5.3.0
      with:
        build-args: |
          APOOL_VERSION=${{ needs.check_ver.outputs.release-ver }}
        context: ${{ env.DOCKER_CONTEXT }}
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.ORG_NAME }}/${{ env.IMAGE_NAME }}:{{ needs.check_ver.outputs.release-ver }}
          ${{ env.REGISTRY }}/${{ env.ORG_NAME }}/${{ env.IMAGE_NAME }}:latest
          
    
